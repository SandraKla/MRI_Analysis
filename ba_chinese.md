论文题目	基于软件工具R的开发和实现用于分析和可视化大脑的MRI图像
一、选题背景与意义（不少于500字）
在物理，化学，医学等领域，核磁共振技术都有非常广泛的应用。磁共振成像简称MRI，其是利用核磁共振的原理，获知构成该物体原子核的位置和种类，再将其绘制成物体内部的结构图像。该技术通常运用于人体内部结构的成像，在医学的临床诊断方面起到了非常大的作用。
人类大脑皮层是一个高度折叠的神经元层，大脑皮层的厚度从1到4毫米不等,平均值约为2.5mm。大脑皮层上的各个区域的厚度变化也是非常的大，并且厚度变化没有规律。人体大脑的皮层厚度异常可能会引起许多疾病，比如癫痫，阿尔兹海默症等。通常情况人们使用FreeSurfer等软件对MRI图像进行分析计算，从而获得大脑中各个区域的皮层厚度。目前暂无基于R语言设计开发的大脑相关皮层厚度分析的程序。                                                                                                                                                                                            
为了让用户更加直观的观察到大脑皮层各个区域的厚度，我们开发了一个基于R语言平台，具有分析能力和可视化能力的3D大脑模型的程序。3D大脑模型相比起2D大脑模型在对用户的友好度以及可视化能力上更具有优势，可以让用户更加动态和方便的观察到大脑的各个区域。该程序根据用户提供的大脑皮层各个区域的厚度值，使用不同的颜色以呈现不同区域的厚度。与此同时，程序被附加上以下功能来更好的满足用户的需求: 数据筛选，描述性统计，3D大脑模型颜色自定义，Lasso回归分析，线性回归分析，雨云图，3D大脑模型下载等等。这些功能帮助相关科研人员在R语言的环境下更加便捷的对人类大脑皮层的厚度值变化进行分析研究。



二、研究内容（解决问题方案、分析测试方法、技术关键、理论分析、论点及论据、计算说明、创新点等，不少于2500字。）
该项目程序可以根据用户提供的大脑数据集，生成一个3D大脑模型，其3D大脑模型以不同的颜色来区分大脑皮层厚度值，同时以数据集为基础对数据进行可视化分析。该程序的开发基于R语言，并使用R中CRAN库中的17个包。在开发过程中还同时使用了来自第三方作者的包或者文件。为了使生成的3D大脑模型更好满足用户的需求，我们对部分第三方作者的包中的部分代码进行了调整。因为第三方作者会定期对他们开发的第三方包中的相关函数进行修改和维护。用户安装的永远是最新的第三方包。我们为了避免经过更新维护后的第三方包不匹配当前开发的程序，因此将部分重要的第三方作者包下载到本地进行调用。
对于一个数据分析和3D大脑模型生成的程序来说，一键导入数据功能是十分重要的。通过该功能，用户可以更加专注的去利用该数据分析软件，而不是在思考如何去使用该数据分析软件。用户可以自行导入两种类型的数据集。通常情况该数据集可以为csv或者xlsx格式的文件，当然对于这两种数据集，其内容格式同样有严格的要求。第一类数据集的内容涉及到每一位被调查者左半脑以及右半脑共计148个大脑区域以及其相关的个人信息数据。第二类数据集内容涉及到被调查者大小脑各个区域的体积等相关数据。该两种数据集在程序中可以使用的功能也有所差异，第一类数据集可以使用该程序的所有功能，第二类数据集仅不支持3D大脑模型的生成。
该程序提供数据集筛选功能。数据筛选功能的目的是为了让用户可以快速选择出满足他们需求的数据。有的用户想要查询某个人的数据，例如编号为001的被调查者的数据，有的用户想查询特定人群的数据，例如年龄在19到22岁之间所有被调查者的数据。针对用户的需求，设计了该功能，以保证用户可以快速的找到自己需求的数据。在开发时使用get_choice()函数来存放筛选后的数据。对数据进行筛选的代码是一个反应表达式。每当用户修改他们需要筛选的选项时，服务器中的get_choice()函数会再次被调用。这意味着数据会在被使用的时候及时更新。假如用户对需要进行筛选的选项没有改变时，该反应表达式不会重复运行，避免产生资源的浪费。
人机交互就应该简洁明了，为了让用户与软件的交互达到简洁和直接的目的。我们设计了一个功能。当用户选择了具体的筛选条件后，该程序会自动生成相应的选择框。该功能的核心函数为renderUI()。renderUI()是一个可以根据用户的输入动态创建部件的函数，它的工作原理和其他render类函数一样。当用户选择了筛选的内容后，该函数根据用户的选择自动生成选择框，输入框，滑动条等部件。针对输入框和滑动条，程序通过min()和max()函数，会自动获取对应数据集中的最大值以及最小值，并且将其设定为滑动条的上下限。自动获取对应数据集最大最小值的好处是，当用户使用自己上传的数据集时，程序可以更好的兼容对应的数据集，避免出现数据集范围不符合，导致产生的图形不符合实际的情况。
针对生成3D大脑模型的功能。当用户选择某一个被调查者的数据时，其可以直接生成对应的3D大脑模型。但是时常用户会对一个群体的数据感兴趣。当用户在分析一个群体的数据时，需要对这一个群体的人的大脑皮层厚度首先进行处理分析，随后再将通过处理分析后的数据生成对应的3D大脑模型。为了适应这种情况，在用户可以根据平均值，中位数，标准差或者标准误生成对应的3D大脑模型。之所以使用平均数, 中位数, 标准差和标准误是因为：
1. 平均数是一组常规样本在大概率上最具有代表性的统计量，通过平均数可以反应样本的整体情况。但是当样本存在特殊情况时，例如这组样本中存在一个极大的离群值，那么这个时候平均数就不能够很有效的反映出样本的真实特征。
2. 中位数也是一个很好用的统计量，其可以用来弥补平均数在偏态分布中的不足之处。所以当平均数无效时，就可以用到中位数。
3. 标准差用来表达数据点的离散程度，之所以不用方差是因为标准差的数量级与样本的数量级相同，标准差相比起方差更适合让人理解。
4. 标准误差用来表示几组抽样样本之间的误差大小，当样本之间误差越小，样本对总体越具有代表性，其样本的可靠程度就越高。
数据可视化时，往往不能忽视色彩的重要性。在一个图表中，数据的内容以及图表的呈现是最重要的。因此如果开发者选择适当的颜色来呈现可视化的数据，那么数据图表不仅可以让阅读者赏心悦目，同样也有助于数据关系的呈现，让整个图表更具有说服力。在3D大脑模型项目中，3D大脑模型的颜色对用户有着非常重要的作用。在该程序中，根据用户的需求自定义3D大脑模型呈现的颜色以及范围的功能必不可少。在这里使用了colourpicker包中的colourInput输入函数。colourInput()函数可以生成包含所有颜色的调色板，用户可以直接选择他们想要的颜色。该函数的返回值是十六进制颜色码。十六进制颜色码是程序中设定颜色的代码。将该返回值传递进入ggseg3d函数中(ggseg3d为生成3D大脑模型的函数)，即可生成选定颜色的3D大脑模型。用户除了使用调色盘进行颜色的选择，还可以直接手动输入16进制颜色码进行颜色的选择。当用户手动输入16进制颜色码后，其调色盘会自动跳转到对应的颜色，给用户进行预览。
在生成3D大脑模型时，仅仅设置上下边界的值和颜色往往不足以满足用户使用的多样性。用户认为他们需要在上下边界之间插入更多的颜色和数值，以此来具体分析有多少大脑区域在对应的各个范围内。InsertUI函数中部分内容需要按照jQuery语言的语法进行编写。该函数的作用是让用户可以随时随地的向应用中添加新的动态对象例如部件。每当用户点击相对应的按钮时，系统将运行一次insertUI()函数并且创建一个新增颜色的小组件和一个新增输入数字的小组件。新增的组件可以被插入对象可以在4个位置，分别是beforeBegin, afterBegin, beforeEnd或者afterEnd。在这里新增的颜色组件也使用了colourInput()函数。colourInput()函数生成的调色盘可以保证可选颜色的多样性。而removeUI()函数的功能与insertUI()函数功能完全相反。
有时候用户会存在一些要求。用户需要对同一个人的左右大脑进行对比。在ggseg3d函数中参数hemisphere可以选择生成的3D大脑模型为左半脑或者右半脑。经过测试，当hemisphere参数以向量形式输入，即c(right,left)。ggseg3d函数会将自动检索数据集中的数据。根据相关标签确定相关大脑皮层厚度值是属于左半脑或者是属于右半脑，并生成3D大脑模型。换句话说，是否能生成有颜色的大脑依赖于用户提供的数据。当然即使用户不提供数据，完整的大脑也能生成，但是不包含颜色。
用户使用该程序生成3D大脑模型后，若期望能够将所生成的3D大脑模型导出。最传统的方法就是用户使用截图工具对其进行截图，但是截图的图片质量不佳，并且不能够很好地导出为各个格式的图片。3D大脑模型的生成基于ggseg3d和plotly包。因此在3D大脑模型右上角提供了png格式的图像输出功能。但是单纯的png下载功能往往图片的锐度不足，并不能满足用户实际的需求。我们由此在程序中一个额外的图像下载功能，该功能的设计基于orca()函数。当3D大脑模型通过ggseg3d()函数被生成后，event_register(“plotly_relayout”)函数将会对用户改变图形布局的行为进行监控，同时自动返回图形当前信息。用户对3D大脑模型实时操作将改变数据，这些改变后的数据都将被保存在“plotly_relayout”参数里。然后程序使用event_data()函数调用plotly_relayout参数，获取其中scene.camera[[“eye”]]的单列数据。该数据代表3D大脑模型的当前状态。随后将scene.camera[[“eye”]]的数据修改处理后，运用到gg_eye上并对其进行了重新布局。最后使用orca()函数，它将重新布局后的gg_eye输出为pdf，svg或者png文件。
为了方便用户使用，在程序的最下方附加了一个“重置按钮”。当用户点击“重置按钮”，可以快速的回到程序最开始的状态。用户不必关闭程序再重新开启程序进行重置，造成时间和资源上的浪费。相关代码的原理是让整个程序回到初始的历史状态。
该程序除了生成3D大脑模型，还可以对数据集进行分析。在数据分析中，表格是将数据直接呈现给用户的一种表达方式。shiny包中的renderTable()函数即可将数据转换成表格输出。但是在大数据时代，简单的表格已经不能满足如今用户的需求。因此DT包中的DataTable()函数被使用。该函数生成的表格拥有分页，排序等其他功能。开发者在使用过程中需要与shiny包中的Table进行区分，因此开发者需要使用DT::dataTableOutput()函数与 DT::renderDataTable()函数。即在函数前加上“DT”。DT包中的DataTable与shiny中自带的Table相比拥有以下优势：1. 优秀的界面显示效果2. 提供表格内容筛选，分页功能 3. 可对数据进行排序以及编辑。
在开发过程期间，tabsetPanel被使用，其被用于分页处理。通过tabPanel()函数可以设置每一个分页的名字以及该分页下显示的内容。因此用户通过分页除了可以查看表格，同样也能查看3D大脑模型和统计数据。
为了在有限的空间里展示丰富的信息，雨云图是一个非常不错的选择。雨云图因为外观像下雨的云因为得名。实际上雨云图是由一个箱型图，一个核密度图和一个点状图（dotplot）组成。箱型图的优点是可以查看有关数据的信息，比如平均值，中位数，四分位数，最大值和最小值。通过中位数和四分位数等信息，可以大致了解数据分布最密集的地方。为了让3D大脑模型的用户可以更加清晰的对一群人的大脑皮层厚度进行分析，以及了解这一群人大脑皮层各个区域厚度的分布情况，因此使用雨云图对其进行分析。我们通过geom_flat_violin(), geom_point(), geom_boxplot()三个函数将每个大脑区域的数据分别生成小提琴图，散点图和箱型图。小提琴图中包含核密度图。然后将这3个图叠加在一起并输出。为了让生成的雨云图排列更加美观。我们使用facet_wrap()函数，facet_wrap()函数帮助我们将图表的呈现变成多列，可以更好的利用显示的空间。
简单线性回归可以展示出数据集的大概集中趋势,以及在数据集中大脑皮层的厚度是否和另外的变量有统计上的相互依赖关系(比如说人的年龄,对事物的反应时间等)。我们通过ggplot2包来绘制线性回归图, 它可以粗略并且快速地展示自变量(在此程序中为大脑皮层厚度)与因变量(在此程序中为被用户选定的一列数据)的线性关系。
针对lasso回归。程序调用glmnet包中的cv.glmnet进行交叉检验。通过不断验证不同lambda的值的回归效果,得到最佳的lambda值,通过给定的lambda值来获得该次分析的各项系数。通过自助抽样法(bootstrap method), 可以将样本的数量大量增加,其增加结果的可靠性。在lasso 线性回归中, 经常会出现某项变量的系数为0的情况,以此可以排除该项变量是否对因变量起效。在最后通过统计这些变量为非0的概率,可以体现该项变量是否对因变量有稳定的影响。bootstrap由于构造大量的数据,往往需要较大量的时间进行计算,程序在计算期间提供了准确的进度条,以便用户进行对计算过程以及时间进行把握。
在保障功能正常运作的情况下，我们对整体的程序UI界面做了优化，更加符合用户的使用感受和需求。同时该用户界面基于R-shiny进行打造。因此该程序可以脱离网络，进行离线使用。当然同样也可以上传至云端服务器，供用户远程使用。

三、结论（或应用）（本论文工作得出的主要结论或应用领域，简明扼要，500字左右。）
该程序是基于R语言平台进行开发，并使用shiny包构建交互界面，为用户提供了友好的交互体验。目前该程序可以正常运行以下功能： 高度个性化自定义3D大脑模型生成，数据筛选分析，雨云图生成，统计数据导出，相关图片兼容多格式导出，lasso回归分析，单变量线性回归分析等。
上述功能主要为了研究人员能够对数据进行可视化的分析。当然就目前设计的程序，还存在很多需要优化和拓展的功能。
第一，地图集适配。该程序基于desterieux地图集，因此在未来程序仍可以适配更多的地图集。
第二，图片输出格式增加。现在程序仅仅支持png，pdf，svg格式输出，这3种格式文件已经足够在各类软件上加载使用。假如更多的输出格式被适配，那么对兼容其他应用有一定的帮助。
第三，界面优化与程序运行速度提升。现阶段数据量大小适中，因此在生成统计图表和3D大脑模型时，并不会消耗太多时间。当数据量被增大时，运行速度必然会有所下降。因此有一些代码需要被改为多线程运行，提升运行速度。
第四，异常值检测。当数据中出现远高于正常范围内的大脑皮层厚度值时，该异常值被程序自动标记并警告用户。
该程序的使用途径非常广，可以运用于数据分析领域或者生物学领域。例如可为研究大脑皮层厚度的相关科研人员提供可视化的3D大脑模型。可帮助数据研究员将数据转换为雨云图或者进行数据相关性分析等等。
在最后我们十分感谢教授以及其他人员对该程序开发提供的帮助。我们希望该程序在将来能够帮助到相关的科研人员，为他们的相关研究提供一定程度上的支持。